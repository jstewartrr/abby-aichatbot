<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABBY-AI - Multi-Model Chat Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-900: #0A0F1C; --primary-800: #151B2E; --primary-700: #1E2642; --primary-600: #283352;
            --accent-primary: #4F8CFF; --accent-secondary: #A855F7; --accent-success: #22C55E;
            --claude-color: #D97706; --gpt-color: #10B981; --gemini-color: #6366F1; --perplexity-color: #14B8A6;
            --grok-color: #EF4444; --deepseek-color: #3B82F6; --copilot-color: #6264A7; --bedrock-color: #FF9900;
            --text-primary: #F8FAFC; --text-secondary: #94A3B8; --text-muted: #64748B;
            --border-subtle: rgba(148,163,184,0.1); --border-accent: rgba(79,140,255,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--primary-900); color: var(--text-primary); height: 100vh; overflow: hidden; }
        
        .login-screen { position: fixed; inset: 0; background: var(--primary-900); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-screen.hidden { display: none; }
        .login-box { width: 400px; padding: 40px; background: var(--primary-800); border-radius: 16px; border: 1px solid var(--border-subtle); }
        .login-logo { width: 70px; height: 70px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 24px; color: white; }
        .login-title { text-align: center; font-family: 'Plus Jakarta Sans'; font-size: 24px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 28px; }
        .login-input { width: 100%; padding: 14px; background: var(--primary-700); border: 1px solid var(--border-subtle); border-radius: 10px; color: var(--text-primary); font-family: 'JetBrains Mono'; margin-bottom: 16px; }
        .login-input:focus { outline: none; border-color: var(--accent-primary); }
        .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; }
        .login-error { color: #EF4444; text-align: center; margin-top: 12px; display: none; }
        .login-error.show { display: block; }

        .app-container { display: none; grid-template-columns: 260px 1fr 380px; grid-template-rows: 60px 1fr; height: 100vh; }
        .app-container.active { display: grid; }
        
        .header { grid-column: 1/-1; background: var(--primary-800); border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .logo-text { font-family: 'Plus Jakarta Sans'; font-weight: 700; font-size: 20px; }
        .header-nav { display: flex; gap: 8px; }
        .nav-btn { background: transparent; border: none; color: var(--text-secondary); padding: 10px 16px; border-radius: 8px; cursor: pointer; }
        .nav-btn:hover, .nav-btn.active { background: var(--primary-700); color: var(--accent-primary); }
        .header-actions { display: flex; align-items: center; gap: 16px; position: relative; }
        .model-selector { display: flex; align-items: center; gap: 10px; background: var(--primary-700); padding: 8px 16px; border-radius: 10px; cursor: pointer; border: 1px solid var(--border-subtle); }
        .model-indicator { width: 10px; height: 10px; border-radius: 50%; }
        .model-dropdown { position: absolute; top: 50px; right: 80px; background: var(--primary-800); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 8px; min-width: 220px; z-index: 100; display: none; }
        .model-dropdown.open { display: block; }
        .model-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; }
        .model-option:hover, .model-option.active { background: var(--primary-700); }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--gemini-color)); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        
        .sidebar { background: var(--primary-800); border-right: 1px solid var(--border-subtle); padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }
        .sidebar-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
        .new-chat-btn { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; }
        .chat-item, .model-list-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; }
        .chat-item:hover, .model-list-item:hover { background: var(--primary-700); }
        .chat-item.active { background: var(--primary-700); border-left: 2px solid var(--accent-primary); }
        .chat-icon { width: 8px; height: 8px; border-radius: 50%; }
        .chat-title, .model-list-name { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .chat-area { display: flex; flex-direction: column; background: var(--primary-900); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; }
        .message { display: flex; gap: 16px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } }
        .message-avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .message.user .message-avatar { background: linear-gradient(135deg, var(--accent-primary), var(--gemini-color)); }
        .message.ai .message-avatar { background: var(--primary-700); border: 1px solid var(--border-subtle); }
        .message-content { flex: 1; min-width: 0; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .message-author { font-weight: 600; }
        .message-model { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); }
        .message-time { font-size: 12px; color: var(--text-muted); margin-left: auto; }
        .message-text { font-size: 15px; line-height: 1.7; color: var(--text-secondary); word-wrap: break-word; }
        .message.ai .message-text { background: var(--primary-800); padding: 16px 20px; border-radius: 12px; border: 1px solid var(--border-subtle); }
        .message-actions { display: flex; gap: 8px; margin-top: 8px; opacity: 0; transition: opacity 0.2s; }
        .message:hover .message-actions { opacity: 1; }
        .action-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-muted); font-size: 12px; cursor: pointer; }
        .action-btn:hover { background: var(--primary-700); }
        
        .context-panel { background: linear-gradient(135deg, rgba(79,140,255,0.1), rgba(168,85,247,0.1)); border: 1px solid var(--border-accent); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        .context-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .context-title { font-size: 14px; font-weight: 600; color: var(--accent-primary); }
        .context-item { font-size: 13px; color: var(--text-secondary); padding: 4px 0; }
        .context-item::before { content: 'â”œâ”€ '; color: var(--text-muted); font-family: monospace; }
        .context-item:last-child::before { content: 'â””â”€ '; }
        
        .typing-indicator { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--primary-800); border-radius: 12px; width: fit-content; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dot { width: 8px; height: 8px; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%,60%,100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-6px); opacity: 1; } }
        
        .input-area { padding: 20px 24px; border-top: 1px solid var(--border-subtle); background: var(--primary-800); }
        .input-wrapper { display: flex; align-items: flex-end; gap: 12px; background: var(--primary-900); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 12px 16px; }
        .input-wrapper:focus-within { border-color: var(--accent-primary); }
        .input-field { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 15px; resize: none; min-height: 24px; max-height: 120px; outline: none; font-family: inherit; }
        .input-actions { display: flex; gap: 8px; }
        .input-action-btn { width: 36px; height: 36px; border-radius: 10px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .input-action-btn:hover { background: var(--primary-700); }
        .send-btn { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; color: white; cursor: pointer; font-size: 18px; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-options { display: flex; gap: 16px; margin-top: 12px; }
        .option-select { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
        .option-select select { background: var(--primary-700); border: 1px solid var(--border-subtle); border-radius: 6px; padding: 6px 12px; color: var(--text-secondary); }
        
        .artifact-panel { background: var(--primary-800); border-left: 1px solid var(--border-subtle); display: flex; flex-direction: column; }
        .artifact-header { display: flex; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); }
        .artifact-title { font-family: 'Plus Jakarta Sans'; font-weight: 600; }
        .artifact-tabs { display: flex; gap: 4px; }
        .artifact-tab { padding: 6px 12px; background: transparent; border: none; color: var(--text-muted); border-radius: 6px; cursor: pointer; }
        .artifact-tab.active { background: var(--primary-700); color: var(--accent-primary); }
        .artifact-content { flex: 1; overflow-y: auto; padding: 20px; }
        .artifact-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .artifact-empty-icon { font-size: 48px; opacity: 0.5; margin-bottom: 16px; }
        .artifact-footer { padding: 16px 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 8px; }
        .export-btn { padding: 8px 14px; background: var(--primary-700); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-secondary); cursor: pointer; }
        .export-btn.primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border: none; color: white; }
        
        .status-badge { position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; background: var(--primary-800); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 12px; color: var(--text-muted); z-index: 50; transition: opacity 0.3s; }
        .status-badge.connected { border-color: var(--accent-success); color: var(--accent-success); }
        .status-badge.error { border-color: var(--grok-color); color: var(--grok-color); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-600); border-radius: 4px; }
        @media (max-width: 1200px) { .artifact-panel { display: none; } .app-container.active { grid-template-columns: 260px 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .app-container.active { grid-template-columns: 1fr; } .header-nav { display: none; } }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">AI</div>
            <h1 class="login-title">ABBY AI Chatbot</h1>
            <p class="login-subtitle">Multi-Model AI Interface</p>
            <input type="password" class="login-input" id="tokenInput" placeholder="Enter access token">
            <button class="login-btn" onclick="attemptLogin()">Access Dashboard</button>
            <p class="login-error" id="loginError">Invalid access token</p>
        </div>
    </div>
    
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="logo"><div class="logo-icon">AI</div><span class="logo-text">ABBY-AI</span></div>
            <nav class="header-nav">
                <button class="nav-btn active">Models</button>
                <button class="nav-btn">Research</button>
                <button class="nav-btn">Spaces</button>
                <button class="nav-btn">Hive Mind</button>
            </nav>
            <div class="header-actions">
                <div class="model-selector" onclick="toggleDropdown()">
                    <div class="model-indicator" id="modelInd" style="background:var(--gpt-color)"></div>
                    <span id="modelName">GPT-4o</span>
                    <span>â–¾</span>
                </div>
                <div class="model-dropdown" id="dropdown"></div>
                <div class="user-avatar">YG</div>
            </div>
        </header>
        
        <aside class="sidebar">
            <button class="new-chat-btn" onclick="newChat()">âœ¨ New Chat</button>
            <div><div class="sidebar-title">Recent Chats</div><div id="history"></div></div>
            <div><div class="sidebar-title">Available Models</div><div id="models"></div></div>
        </aside>
        
        <main class="chat-area">
            <div class="chat-messages" id="messages"></div>
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea class="input-field" id="input" placeholder="Message GPT-4o..." rows="1" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
                    <div class="input-actions">
                        <button class="input-action-btn">ðŸ“Ž</button>
                        <button class="input-action-btn">ðŸŽ¤</button>
                        <button class="send-btn" id="sendBtn" onclick="send()" disabled>âž¤</button>
                    </div>
                </div>
                <div class="input-options">
                    <div class="option-select"><span>Focus:</span><select><option>All</option><option>Code</option><option>Research</option></select></div>
                    <div class="option-select"><span>Tone:</span><select><option>Professional</option><option>Casual</option></select></div>
                </div>
            </div>
        </main>
        
        <aside class="artifact-panel">
            <div class="artifact-header"><span class="artifact-title">Artifacts</span><div class="artifact-tabs"><button class="artifact-tab active">Preview</button><button class="artifact-tab">Code</button></div></div>
            <div class="artifact-content"><div class="artifact-empty"><div class="artifact-empty-icon">ðŸ“„</div><p style="color:var(--text-muted)">Artifacts appear here</p></div></div>
            <div class="artifact-footer"><button class="export-btn">ðŸ“¥ Download</button><button class="export-btn primary">ðŸš€ Deploy</button></div>
        </aside>
    </div>
    
    <div class="status-badge" id="statusBadge">Checking connection...</div>

<script>
// MCP Backend endpoints - Using your existing Azure Container Apps
const MCP_ENDPOINTS = {
    gpt: 'https://openai-mcp.lemoncoast-87756bcf.eastus.azurecontainerapps.io/mcp',
    gemini: 'https://gemini-mcp.lemoncoast-87756bcf.eastus.azurecontainerapps.io/mcp',
    grok: 'https://grok-mcp.lemoncoast-87756bcf.eastus.azurecontainerapps.io/mcp',
    vertex: 'https://vertex-mcp.lemoncoast-87756bcf.eastus.azurecontainerapps.io/mcp'
};

// Tool names for each model
const MCP_TOOLS = {
    gpt: 'openai_chat',
    gemini: 'gemini_generate_content', 
    grok: 'grok_chat',
    vertex: 'vertex_gemini_generate'
};

const CFG = {
    HASH: '9b74f3a0e5c72a838737cd59fd71a2e62324b4860c236da7b801f980c65f58f0',
    MODELS: {
        gpt: { n: 'GPT-4o', i: 'ðŸ¤–', c: 'var(--gpt-color)', endpoint: 'gpt', tool: 'openai_chat' },
        gemini: { n: 'Gemini 2.5 Pro', i: 'âœ¨', c: 'var(--gemini-color)', endpoint: 'gemini', tool: 'gemini_generate_content' },
        grok: { n: 'Grok 4', i: 'âš¡', c: 'var(--grok-color)', endpoint: 'grok', tool: 'grok_chat' },
        claude: { n: 'Claude (via Vertex)', i: 'ðŸ§ ', c: 'var(--claude-color)', endpoint: 'vertex', tool: 'vertex_gemini_generate' },
        perplexity: { n: 'Perplexity Pro', i: 'ðŸ”', c: 'var(--perplexity-color)', endpoint: 'gpt', tool: 'openai_chat' },
        deepseek: { n: 'DeepSeek R1', i: 'ðŸŒŠ', c: 'var(--deepseek-color)', endpoint: 'gpt', tool: 'openai_chat' },
        copilot: { n: 'MS Copilot', i: 'ðŸŒ', c: 'var(--copilot-color)', endpoint: 'gpt', tool: 'openai_chat' },
        bedrock: { n: 'AWS Bedrock', i: 'â˜ï¸', c: 'var(--bedrock-color)', endpoint: 'gpt', tool: 'openai_chat' }
    }
};

let model = 'gpt', msgs = [], hist = [], chatId = Date.now() + '', busy = false;

async function sha(s) { 
    const b = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)); 
    return Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2, '0')).join(''); 
}

async function attemptLogin() {
    const t = document.getElementById('tokenInput').value.trim();
    if (await sha(t) === CFG.HASH) {
        localStorage.setItem('auth', t);
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.add('active');
        init();
    } else {
        document.getElementById('loginError').classList.add('show');
        setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
    }
}

async function checkAuth() {
    const t = localStorage.getItem('auth');
    if (t && await sha(t) === CFG.HASH) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.add('active');
        init();
    }
}

function init() {
    renderModels();
    renderDropdown();
    loadHist();
    render();
    testConnection();
    document.getElementById('tokenInput').onkeydown = e => { if (e.key === 'Enter') attemptLogin(); };
}

async function testConnection() {
    const badge = document.getElementById('statusBadge');
    try {
        const r = await fetch('https://openai-mcp.lemoncoast-87756bcf.eastus.azurecontainerapps.io/');
        const d = await r.json();
        if (d.status === 'healthy') {
            badge.textContent = 'âœ“ Connected to MCP Gateway';
            badge.className = 'status-badge connected';
        } else throw new Error('unhealthy');
    } catch (e) {
        badge.textContent = 'âš  Limited connectivity';
        badge.className = 'status-badge error';
    }
    setTimeout(() => badge.style.opacity = '0.5', 3000);
}

function renderModels() {
    document.getElementById('models').innerHTML = Object.entries(CFG.MODELS).map(([k, m]) =>
        `<div class="model-list-item" onclick="sel('${k}')"><div class="model-indicator" style="background:${m.c}"></div><span class="model-list-name">${m.n}</span></div>`
    ).join('');
}

function renderDropdown() {
    document.getElementById('dropdown').innerHTML = Object.entries(CFG.MODELS).map(([k, m]) =>
        `<div class="model-option${k === model ? ' active' : ''}" onclick="sel('${k}');toggleDropdown();"><div class="model-indicator" style="background:${m.c}"></div><span>${m.n}</span></div>`
    ).join('');
}

function toggleDropdown() { document.getElementById('dropdown').classList.toggle('open'); }

function sel(m) {
    model = m;
    document.getElementById('modelInd').style.background = CFG.MODELS[m].c;
    document.getElementById('modelName').textContent = CFG.MODELS[m].n;
    document.getElementById('input').placeholder = `Message ${CFG.MODELS[m].n}...`;
    renderDropdown();
}

function loadHist() { try { hist = JSON.parse(localStorage.getItem('abby_hist') || '[]'); } catch (e) { hist = []; } renderHist(); }

function saveHist() {
    if (msgs.length) {
        const t = msgs.find(x => x.r === 'user')?.c?.slice(0, 40) || 'New Chat';
        const i = hist.findIndex(x => x.id === chatId);
        const d = { id: chatId, t, m: model, msgs: [...msgs], ts: Date.now() };
        if (i >= 0) hist[i] = d; else hist.unshift(d);
        hist = hist.slice(0, 50);
        localStorage.setItem('abby_hist', JSON.stringify(hist));
        renderHist();
    }
}

function renderHist() {
    document.getElementById('history').innerHTML = hist.slice(0, 10).map(c =>
        `<div class="chat-item${c.id === chatId ? ' active' : ''}" onclick="loadChat('${c.id}')"><div class="chat-icon" style="background:${CFG.MODELS[c.m]?.c || 'var(--gpt-color)'}"></div><span class="chat-title">${esc(c.t)}</span></div>`
    ).join('');
}

function loadChat(id) {
    const c = hist.find(x => x.id === id);
    if (c) { chatId = c.id; model = c.m; msgs = c.msgs.map(x => ({ ...x })); sel(model); render(); renderHist(); }
}

function newChat() { saveHist(); msgs = []; chatId = Date.now() + ''; render(); renderHist(); }

function render() {
    const m = document.getElementById('messages');
    m.innerHTML = `<div class="context-panel"><div class="context-header"><span>ðŸ§ </span><span class="context-title">Hive Mind Context Active</span></div><div class="context-item">Connection: MCP Gateway (Azure)</div><div class="context-item">Active Model: ${CFG.MODELS[model].n}</div><div class="context-item">Session: ${chatId.slice(-8)}</div></div>` +
        msgs.map((x, i) => {
            const M = CFG.MODELS[x.m] || CFG.MODELS.gpt;
            const t = x.ts ? new Date(x.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            return `<div class="message ${x.r === 'user' ? 'user' : 'ai'}"><div class="message-avatar">${x.r === 'user' ? 'YG' : M.i}</div><div class="message-content"><div class="message-header"><span class="message-author">${x.r === 'user' ? 'Your Grace' : M.n}</span>${x.r !== 'user' ? `<div class="message-model"><div class="model-indicator" style="background:${M.c};width:6px;height:6px;border-radius:50%"></div><span>${M.n.split(' ')[0]}</span></div>` : ''}<span class="message-time">${t}</span></div><div class="message-text">${fmt(x.c)}</div><div class="message-actions"><button class="action-btn" onclick="copyMsg(${i})">ðŸ“‹ Copy</button>${x.r !== 'user' ? '<button class="action-btn" onclick="regen()">ðŸ”„ Regenerate</button>' : ''}</div></div></div>`;
        }).join('');
    m.scrollTop = m.scrollHeight;
}

function showTyping() {
    const M = CFG.MODELS[model];
    const d = document.createElement('div');
    d.id = 'typing';
    d.className = 'message ai';
    d.innerHTML = `<div class="message-avatar">${M.i}</div><div class="typing-indicator"><div class="typing-dots"><div class="typing-dot" style="background:${M.c}"></div><div class="typing-dot" style="background:${M.c}"></div><div class="typing-dot" style="background:${M.c}"></div></div><span style="color:var(--text-muted);font-size:13px;margin-left:8px">${M.n} is thinking...</span></div>`;
    document.getElementById('messages').appendChild(d);
    d.scrollIntoView({ behavior: 'smooth' });
}

function hideTyping() { const e = document.getElementById('typing'); if (e) e.remove(); }

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
}

function autoGrow(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    document.getElementById('sendBtn').disabled = !el.value.trim();
}

async function send() {
    const inp = document.getElementById('input'), c = inp.value.trim();
    if (!c || busy) return;
    busy = true;
    document.getElementById('sendBtn').disabled = true;
    msgs.push({ r: 'user', c, m: model, ts: Date.now() });
    render();
    inp.value = '';
    inp.style.height = 'auto';
    showTyping();
    
    try {
        const res = await callMCP(c);
        hideTyping();
        msgs.push({ r: 'ai', c: res, m: model, ts: Date.now() });
        render();
    } catch (e) {
        hideTyping();
        msgs.push({ r: 'ai', c: 'Error: ' + e.message, m: model, ts: Date.now() });
        render();
    }
    
    busy = false;
    document.getElementById('sendBtn').disabled = false;
    saveHist();
}

async function callMCP(msg) {
    const M = CFG.MODELS[model];
    const endpoint = MCP_ENDPOINTS[M.endpoint] || MCP_ENDPOINTS.gpt;
    const tool = M.tool || 'openai_chat';
    
    // Build system context
    const systemPrompt = `You are ${M.n}, an AI assistant in the ABBY AI multi-model chat interface. You are speaking with "Your Grace" who is the Chairman of MiddleGround Capital. Be helpful, professional, and concise.`;
    
    // Build message with context from previous messages
    const contextMsgs = msgs.slice(-6).map(m => `${m.r === 'user' ? 'User' : 'Assistant'}: ${m.c}`).join('\n');
    const fullMessage = contextMsgs ? `Previous context:\n${contextMsgs}\n\nCurrent message: ${msg}` : msg;
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            jsonrpc: '2.0',
            method: 'tools/call',
            params: {
                name: tool,
                arguments: { 
                    message: fullMessage,
                    system: systemPrompt,
                    prompt: fullMessage // For Gemini compatibility
                }
            },
            id: Date.now()
        })
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    if (data.error) throw new Error(data.error.message || 'MCP error');
    
    // Extract response text from MCP result
    const content = data.result?.content?.[0]?.text;
    if (!content) throw new Error('No response from model');
    
    // Parse if JSON response
    try {
        const parsed = JSON.parse(content);
        return parsed.response || parsed.text || parsed.content || content;
    } catch {
        return content;
    }
}

async function regen() {
    if (msgs.length >= 1) {
        const lastUser = [...msgs].reverse().find(m => m.r === 'user');
        if (lastUser) {
            // Remove last AI response if exists
            if (msgs.length && msgs[msgs.length - 1].r === 'ai') msgs.pop();
            render();
            showTyping();
            try {
                const res = await callMCP(lastUser.c);
                hideTyping();
                msgs.push({ r: 'ai', c: res, m: model, ts: Date.now() });
                render();
            } catch (e) {
                hideTyping();
                msgs.push({ r: 'ai', c: 'Error: ' + e.message, m: model, ts: Date.now() });
                render();
            }
            saveHist();
        }
    }
}

function copyMsg(i) {
    if (msgs[i]) navigator.clipboard.writeText(msgs[i].c);
}

function fmt(t) {
    return esc(t)
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre style="background:var(--primary-700);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0;font-family:JetBrains Mono,monospace;font-size:13px"><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code style="background:var(--primary-700);padding:2px 6px;border-radius:4px;font-family:JetBrains Mono,monospace">$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

document.addEventListener('click', e => {
    if (!e.target.closest('.model-selector') && !e.target.closest('.model-dropdown'))
        document.getElementById('dropdown').classList.remove('open');
});

checkAuth();
</script>
</body>
</html>
