<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0A0F1C">
    <title>ABBI-AI.com</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--primary-900:#0A0F1C;--primary-800:#151B2E;--primary-700:#1E2642;--accent-primary:#4F8CFF;--accent-secondary:#A855F7;--claude-color:#D97706;--gpt-color:#10B981;--gemini-color:#6366F1;--grok-color:#EF4444;--deepseek-color:#3B82F6;--text-primary:#F8FAFC;--text-secondary:#94A3B8;--text-muted:#64748B;--border-subtle:rgba(148,163,184,0.1);--border-accent:rgba(79,140,255,0.3);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px)}
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden;touch-action:manipulation}
        body{font-family:'Inter',sans-serif;background:var(--primary-900);color:var(--text-primary);-webkit-font-smoothing:antialiased}
        .app-container{display:grid;grid-template-columns:260px 1fr 380px;grid-template-rows:60px 1fr;height:100dvh;gap:0}
        @media(max-width:1200px){.app-container{grid-template-columns:260px 1fr}.artifact-panel{display:none}}
        @media(max-width:768px){.app-container{grid-template-columns:1fr;grid-template-rows:56px 1fr}.sidebar{position:fixed;left:0;top:0;bottom:0;width:280px;z-index:1000;transform:translateX(-100%);transition:transform .3s ease}.sidebar.open{transform:translateX(0)}.sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;opacity:0;pointer-events:none;transition:opacity .3s ease}.sidebar-overlay.open{opacity:1;pointer-events:auto}.header{padding:0 12px}.header-nav{display:none}.menu-btn{display:flex!important}.model-selector{padding:6px 10px}.model-name{display:none}.chat-messages{padding:12px}.input-area{padding:12px;padding-bottom:calc(12px + var(--safe-bottom))}.input-options{display:none}.message{gap:10px}.message-avatar{width:32px;height:32px;font-size:12px}.message-text{font-size:14px;padding:12px 14px!important}.message-actions{flex-wrap:wrap;gap:6px}.action-btn{padding:6px 10px;font-size:11px}}
        .header{grid-column:1/-1;background:var(--primary-800);border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between;padding:0 24px;padding-top:var(--safe-top)}
        .menu-btn{display:none;width:40px;height:40px;border-radius:10px;background:transparent;border:none;color:var(--text-primary);cursor:pointer;align-items:center;justify-content:center;font-size:20px}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
        .logo-text{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:20px;background:linear-gradient(135deg,var(--text-primary),var(--text-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .header-nav{display:flex;align-items:center;gap:8px}
        .nav-btn{background:transparent;border:none;color:var(--text-secondary);padding:10px 16px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;-webkit-tap-highlight-color:transparent}
        .nav-btn.active{background:var(--primary-700);color:var(--accent-primary)}
        .header-actions{display:flex;align-items:center;gap:16px}
        .model-selector{display:flex;align-items:center;gap:10px;background:var(--primary-700);padding:8px 16px;border-radius:10px;cursor:pointer;border:1px solid var(--border-subtle)}
        .model-indicator{width:10px;height:10px;border-radius:50%;box-shadow:0 0 12px currentColor;flex-shrink:0}
        .model-name{font-weight:600;font-size:14px}
        .model-chevron{color:var(--text-muted);font-size:12px}
        .voice-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--gemini-color));display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px}
        .sidebar{background:var(--primary-800);border-right:1px solid var(--border-subtle);padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:24px;-webkit-overflow-scrolling:touch}
        .sidebar-section{display:flex;flex-direction:column;gap:8px}
        .sidebar-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);padding:0 12px}
        .new-chat-btn{display:flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer}
        .chat-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer}
        .chat-item.active{background:var(--primary-700);border-left:2px solid var(--accent-primary)}
        .chat-icon{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .chat-title{font-size:13px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .space-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer}
        .space-icon{font-size:16px}
        .space-name{font-size:13px;color:var(--text-secondary)}
        .model-list-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer}
        .model-list-item .model-indicator{width:8px;height:8px}
        .model-list-name{font-size:13px;color:var(--text-secondary)}
        .chat-area{display:flex;flex-direction:column;background:var(--primary-900);overflow:hidden}
        .chat-messages{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;display:flex;flex-direction:column;gap:24px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
        .message{display:flex;gap:16px;max-width:100%}
        .message-avatar{width:36px;height:36px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px}
        .message.user .message-avatar{background:linear-gradient(135deg,var(--accent-primary),var(--gemini-color))}
        .message.ai .message-avatar{background:var(--primary-700);border:1px solid var(--border-subtle)}
        .message-content{flex:1;display:flex;flex-direction:column;gap:8px;min-width:0}
        .message-header{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .message-author{font-weight:600;font-size:14px}
        .message-model{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)}
        .message-model .model-indicator{width:6px;height:6px}
        .message-time{font-size:12px;color:var(--text-muted);margin-left:auto}
        .message-text{font-size:15px;line-height:1.5;color:var(--text-secondary);word-wrap:break-word;overflow-wrap:break-word}
        .message.ai .message-text{background:var(--primary-800);padding:16px 20px;border-radius:12px;border:1px solid var(--border-subtle)}
        .message-actions{display:flex;align-items:center;gap:8px;margin-top:8px}
        .action-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;background:transparent;border:1px solid var(--border-subtle);border-radius:6px;color:var(--text-muted);font-size:12px;cursor:pointer}
        .compare-badge{background:linear-gradient(135deg,rgba(79,140,255,.1),rgba(168,85,247,.1));border-color:var(--border-accent);color:var(--accent-primary)}
        .context-panel{background:linear-gradient(135deg,rgba(79,140,255,.1),rgba(168,85,247,.1));border:1px solid var(--border-accent);border-radius:12px;padding:16px;margin-bottom:20px}
        .context-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .context-icon{font-size:18px}
        .context-title{font-size:14px;font-weight:600;color:var(--accent-primary)}
        .context-items{display:flex;flex-direction:column;gap:8px}
        .context-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
        .context-item::before{content:'‚îú‚îÄ';color:var(--text-muted);font-family:monospace}
        .context-item:last-child::before{content:'‚îî‚îÄ'}
        .input-area{padding:20px 24px;padding-bottom:calc(20px + var(--safe-bottom));border-top:1px solid var(--border-subtle);background:var(--primary-800)}
        .input-container{display:flex;flex-direction:column;gap:12px}
        .input-wrapper{display:flex;align-items:flex-end;gap:12px;background:var(--primary-900);border:1px solid var(--border-subtle);border-radius:16px;padding:12px 16px}
        .input-wrapper:focus-within{border-color:var(--accent-primary)}
        .input-field{flex:1;background:transparent;border:none;color:var(--text-primary);font-size:16px;font-family:'Inter',sans-serif;resize:none;min-height:24px;max-height:120px;outline:none;-webkit-appearance:none}
        .input-field::placeholder{color:var(--text-muted)}
        .input-actions{display:flex;align-items:center;gap:8px}
        .input-action-btn{width:40px;height:40px;border-radius:10px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
        .send-btn{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
        .send-btn:disabled{opacity:.5}
        .artifact-panel{background:var(--primary-800);border-left:1px solid var(--border-subtle);display:flex;flex-direction:column}
        .artifact-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border-subtle)}
        .artifact-title{font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;font-size:15px}
        .artifact-content{flex:1;overflow-y:auto;padding:20px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .stat-card{background:var(--primary-900);border:1px solid var(--border-subtle);border-radius:10px;padding:14px}
        .stat-value{font-size:1.5rem;font-weight:700;color:var(--accent-primary)}
        .stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
        .typing-indicator{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--primary-800);border-radius:12px;width:fit-content}
        .typing-dots{display:flex;gap:4px}
        .typing-dot{width:8px;height:8px;border-radius:50%;animation:typing 1.4s infinite}
        .typing-dot:nth-child(2){animation-delay:.2s}
        .typing-dot:nth-child(3){animation-delay:.4s}
        @keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-6px);opacity:1}}
        .model-picker{position:fixed;inset:0;z-index:2000;display:none;align-items:flex-end;justify-content:center}
        .model-picker.open{display:flex}
        .model-picker-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6)}
        .model-picker-content{position:relative;background:var(--primary-800);border-radius:20px 20px 0 0;width:100%;max-width:400px;max-height:70vh;overflow-y:auto;padding:20px;padding-bottom:calc(20px + var(--safe-bottom));animation:slideUp .3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .model-picker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
        .model-picker-title{font-size:18px;font-weight:600}
        .model-picker-close{width:32px;height:32px;border-radius:50%;background:var(--primary-700);border:none;color:var(--text-primary);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .model-picker-item{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;cursor:pointer}
        .model-picker-item.selected{background:var(--primary-700);border:1px solid var(--border-accent)}
        .model-picker-dot{width:12px;height:12px;border-radius:50%}
        .model-picker-name{font-size:15px;font-weight:500}
        .model-picker-desc{font-size:12px;color:var(--text-muted);margin-top:2px}
        @media(max-width:768px){::-webkit-scrollbar{width:0;display:none}}
        .upload-menu-container{position:relative}
        .upload-menu{position:absolute;bottom:100%;left:0;background:var(--primary-700);border:1px solid var(--border-primary);border-radius:12px;padding:8px;margin-bottom:8px;display:none;min-width:180px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000}
        .upload-menu.open{display:block}
        .upload-option{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:14px;transition:background .2s}
        .upload-option:hover{background:var(--primary-600)}
        .upload-option span:first-child{font-size:16px}
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="app-container">
        <header class="header">
            <div style="display:flex;align-items:center;gap:12px">
                <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <div class="logo"><div class="logo-icon">AI</div><span class="logo-text">ABBI-AI</span></div>
            </div>
            <nav class="header-nav">
                <button class="nav-btn active" onclick="switchTab('chat')">Model Chat</button>
                <button class="nav-btn" onclick="switchTab('image')">Image Generation</button>
                <button class="nav-btn" onclick="switchTab('folders')">Folders</button>
                <button class="nav-btn" onclick="switchTab('session')">Session Tracker</button>
            </nav>
            <div class="header-actions">
                <div class="model-selector" onclick="openModelPicker()">
                    <div class="model-indicator" id="modelDot" style="background:var(--claude-color)"></div>
                    <span class="model-name" id="modelLabel">Claude Opus 4.5</span>
                    <span class="model-chevron">‚ñæ</span>
                </div>
                <button class="voice-btn">üéôÔ∏è</button>
                <div class="user-avatar">YG</div>
            </div>
        </header>
        <aside class="sidebar" id="sidebar">
            <button class="new-chat-btn" onclick="newChat();toggleSidebar()"><span>‚ú®</span><span>New Chat</span></button>
            <div class="sidebar-section">
                <div class="sidebar-title">Recent Chats</div>
                <div class="chat-list"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Folders</div>
                <button class="new-chat-btn" onclick="createFolder()" style="margin-bottom:12px">
                    <span>üìÅ</span><span>New Folder</span>
                </button>
                <div class="folder-list" id="folderList"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Models</div>
                <div class="model-list-item" onclick="selectModel('claude-opus');toggleSidebar()"><div class="model-indicator" style="background:var(--claude-color)"></div><span class="model-list-name">Claude Opus 4.5 ‚≠ê</span></div>
                <div class="model-list-item" onclick="selectModel('claude-sonnet');toggleSidebar()"><div class="model-indicator" style="background:var(--claude-color)"></div><span class="model-list-name">Claude Sonnet 4</span></div>
                <div class="model-list-item" onclick="selectModel('gpt-4o');toggleSidebar()"><div class="model-indicator" style="background:var(--gpt-color)"></div><span class="model-list-name">GPT-4o</span></div>
                <div class="model-list-item" onclick="selectModel('gemini-2');toggleSidebar()"><div class="model-indicator" style="background:var(--gemini-color)"></div><span class="model-list-name">Gemini 2.0 Flash</span></div>
                <div class="model-list-item" onclick="selectModel('grok-3');toggleSidebar()"><div class="model-indicator" style="background:var(--grok-color)"></div><span class="model-list-name">Grok 3</span></div>
            </div>
        </aside>
        <main class="chat-area">
            <div class="tab-content" id="chatTab">
                <div class="chat-messages" id="messages">
                    <div class="context-panel">
                        <div class="context-header"><span class="context-icon">üß†</span><span class="context-title">Hive Mind Active</span></div>
                        <div class="context-items">
                            <div class="context-item" onclick="showMCPDetails()" style="cursor:pointer;text-decoration:underline">MCP Gateway: <span id="toolCount">Loading...</span></div>
                            <div class="context-item">Session: <span id="sessionId">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="imageTab" style="display:none">
                <div class="chat-messages">
                    <div style="padding:40px;text-align:center">
                        <h2 style="margin-bottom:16px">Image Generation</h2>
                        <p style="color:var(--text-muted)">AI image generation coming soon</p>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="foldersTab" style="display:none">
                <div class="chat-messages">
                    <div style="padding:40px">
                        <h2 style="margin-bottom:16px">Folder Management</h2>
                        <div id="folderManagement" style="color:var(--text-muted)">Loading folders...</div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="sessionTab" style="display:none">
                <div class="chat-messages">
                    <div style="padding:40px">
                        <h2 style="margin-bottom:16px">Session Tracker</h2>
                        <div id="sessionTracker" style="color:var(--text-muted)">Loading session data...</div>
                    </div>
                </div>
            </div>
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea class="input-field" id="inputField" placeholder="Message ABBI..." rows="1" onkeydown="handleKey(event)"></textarea>
                        <div class="input-actions">
                            <div class="upload-menu-container">
                                <button class="input-action-btn" onclick="toggleUploadMenu()" id="uploadBtn">‚ûï</button>
                                <div class="upload-menu" id="uploadMenu">
                                    <div class="upload-option" onclick="handleUploadFile()">
                                        <span>üìÑ</span><span>Upload file</span>
                                    </div>
                                    <div class="upload-option" onclick="handleTakePicture()">
                                        <span>üì∑</span><span>Take a picture</span>
                                    </div>
                                    <div class="upload-option" onclick="handleTakeScreenshot()">
                                        <span>üñºÔ∏è</span><span>Take a screenshot</span>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(event)" />
                            <button class="input-action-btn">üé§</button>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <aside class="artifact-panel">
            <div class="artifact-header"><span class="artifact-title">‚ö° Gateway</span></div>
            <div class="artifact-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value">200+</div><div class="stat-label">Tools</div></div>
                    <div class="stat-card"><div class="stat-value">11</div><div class="stat-label">Models</div></div>
                </div>
            </div>
        </aside>
    </div>
    <div class="model-picker" id="modelPicker">
        <div class="model-picker-overlay" onclick="closeModelPicker()"></div>
        <div class="model-picker-content">
            <div class="model-picker-header"><span class="model-picker-title">Select Model</span><button class="model-picker-close" onclick="closeModelPicker()">√ó</button></div>
            <div class="model-picker-item selected" onclick="selectModelFromPicker('claude-opus')"><div class="model-picker-dot" style="background:var(--claude-color)"></div><div><div class="model-picker-name">Claude Opus 4.5 ‚≠ê</div><div class="model-picker-desc">Most capable</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('claude-sonnet')"><div class="model-picker-dot" style="background:var(--claude-color)"></div><div><div class="model-picker-name">Claude Sonnet 4</div><div class="model-picker-desc">Balanced performance</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('gpt-4o')"><div class="model-picker-dot" style="background:var(--gpt-color)"></div><div><div class="model-picker-name">GPT-4o</div><div class="model-picker-desc">Versatile</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('gpt-4o-mini')"><div class="model-picker-dot" style="background:var(--gpt-color)"></div><div><div class="model-picker-name">GPT-4o Mini</div><div class="model-picker-desc">Fast & cost-effective</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('o1')"><div class="model-picker-dot" style="background:var(--gpt-color)"></div><div><div class="model-picker-name">o1</div><div class="model-picker-desc">Advanced reasoning</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('gemini-2')"><div class="model-picker-dot" style="background:var(--gemini-color)"></div><div><div class="model-picker-name">Gemini 2.0 Flash</div><div class="model-picker-desc">Fast multimodal</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('gemini-1.5')"><div class="model-picker-dot" style="background:var(--gemini-color)"></div><div><div class="model-picker-name">Gemini 1.5 Pro</div><div class="model-picker-desc">Long context</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('grok-3')"><div class="model-picker-dot" style="background:var(--grok-color)"></div><div><div class="model-picker-name">Grok 3</div><div class="model-picker-desc">Latest xAI</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('nova-pro')"><div class="model-picker-dot" style="background:#FF9900"></div><div><div class="model-picker-name">Amazon Nova Pro</div><div class="model-picker-desc">AWS Bedrock</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('nova-lite')"><div class="model-picker-dot" style="background:#FF9900"></div><div><div class="model-picker-name">Amazon Nova Lite</div><div class="model-picker-desc">Fast AWS model</div></div></div>
            <div class="model-picker-item" onclick="selectModelFromPicker('copilot')"><div class="model-picker-dot" style="background:#6e40c9"></div><div><div class="model-picker-name">GitHub Copilot</div><div class="model-picker-desc">Code assistant</div></div></div>
        </div>
    </div>
    <div class="model-picker" id="mcpModal">
        <div class="model-picker-overlay" onclick="closeMCPModal()"></div>
        <div class="model-picker-content">
            <div class="model-picker-header"><span class="model-picker-title">MCP Gateway Status</span><button class="model-picker-close" onclick="closeMCPModal()">√ó</button></div>
            <div id="mcpServerList" style="max-height:400px;overflow-y:auto"></div>
        </div>
    </div>
<script>
const MODELS={
  'claude-opus':  {name:'Claude Opus 4.5',color:'var(--claude-color)',provider:'anthropic'},
  'claude-sonnet':{name:'Claude Sonnet 4',color:'var(--claude-color)',provider:'anthropic'},
  'gpt-4o':       {name:'GPT-4o',color:'var(--gpt-color)',provider:'openai'},
  'gpt-4o-mini':  {name:'GPT-4o Mini',color:'var(--gpt-color)',provider:'openai'},
  'o1':           {name:'o1',color:'var(--gpt-color)',provider:'openai'},
  'gemini-2':     {name:'Gemini 2.0 Flash',color:'var(--gemini-color)',provider:'google'},
  'gemini-1.5':   {name:'Gemini 1.5 Pro',color:'var(--gemini-color)',provider:'google'},
  'grok-3':       {name:'Grok 3',color:'var(--grok-color)',provider:'xai'},
  'nova-pro':     {name:'Amazon Nova Pro',color:'#FF9900',provider:'bedrock'},
  'nova-lite':    {name:'Amazon Nova Lite',color:'#FF9900',provider:'bedrock'},
  'copilot':      {name:'GitHub Copilot',color:'#6e40c9',provider:'openai'}
};
const MODEL_API_IDS={
  'claude-opus':'claude-opus-4-5-20251101',
  'claude-sonnet':'claude-sonnet-4-20250514',
  'gpt-4o':'gpt-4o',
  'gpt-4o-mini':'gpt-4o-mini',
  'o1':'o1',
  'gemini-2':'gemini-2.0-flash-exp',
  'gemini-1.5':'gemini-1.5-pro',
  'grok-3':'grok-3',
  'grok-2':'grok-2-1212',
  'nova-pro':'amazon.nova-pro-v1:0',
  'nova-lite':'amazon.nova-lite-v1:0',
  'copilot':'gpt-4o'
};
let state={model:'claude-opus',sessionId:'ABBI-'+Math.random().toString(36).substr(2,8).toUpperCase(),history:[]};
document.addEventListener('DOMContentLoaded',()=>{document.getElementById('sessionId').textContent=state.sessionId;document.getElementById('inputField').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'});addWelcome()});
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('open')}
function openModelPicker(){if(window.innerWidth<=768)document.getElementById('modelPicker').classList.add('open')}
function closeModelPicker(){document.getElementById('modelPicker').classList.remove('open')}
function switchTab(tabName){document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));const tabs={chat:'chatTab',image:'imageTab',folders:'foldersTab',session:'sessionTab'};document.getElementById(tabs[tabName]).style.display='block';event.target.classList.add('active');if(tabName==='folders'){loadFolderManagement()}else if(tabName==='session'){loadSessionTracker()}}
function loadFolderManagement(){fetch('/api/folders/list').then(r=>r.json()).then(data=>{const container=document.getElementById('folderManagement');container.innerHTML='<div style="margin-bottom:20px"><button class="new-chat-btn" onclick="createFolder();setTimeout(loadFolderManagement,500)">üìÅ Create New Folder</button></div>';if(data.folders&&data.folders.length>0){data.folders.forEach(f=>{container.innerHTML+=`<div style="padding:12px;background:var(--primary-700);border-radius:8px;margin:8px 0">${f.ICON||'üìÅ'} ${f.NAME}</div>`})}else{container.innerHTML+='<p>No folders yet. Create your first folder!</p>'}}).catch(()=>{document.getElementById('folderManagement').innerHTML='<p>Unable to load folders</p>'})}
function loadSessionTracker(){const container=document.getElementById('sessionTracker');container.innerHTML=`<div style="margin-bottom:20px"><strong>Current Session:</strong> ${state.sessionId}</div><div style="margin-bottom:20px"><strong>Messages in Session:</strong> ${state.history.length}</div><div style="margin-bottom:20px"><strong>Current Model:</strong> ${MODELS[state.model]?.name||'Unknown'}</div><div style="padding:12px;background:var(--primary-700);border-radius:8px"><div style="margin-bottom:8px;font-weight:600">Session History:</div>${state.history.map((m,i)=>`<div style="padding:8px;border-left:2px solid ${m.role==='user'?'var(--accent-primary)':'var(--accent-secondary)'};margin:4px 0;font-size:13px">${i+1}. ${m.role}: ${m.content.substring(0,100)}${m.content.length>100?'...':''}</div>`).join('')||'<div style="color:var(--text-muted)">No messages yet</div>'}</div>`}
function selectModelFromPicker(m){selectModel(m);document.querySelectorAll('.model-picker-item').forEach(i=>i.classList.toggle('selected',i.querySelector('.model-picker-name').textContent.includes(MODELS[m].name)));closeModelPicker()}
function selectModel(m){state.model=m;document.getElementById('modelDot').style.background=MODELS[m].color;document.getElementById('modelLabel').textContent=MODELS[m].name}
function addWelcome(){addMessage('ai','Welcome back, Your Grace. I\'m ABBI.\n\nI have access to <strong>200+ tools</strong> via the MCP Gateway.\n\nHow may I assist you today?')}
function addMessage(type,text){const msgs=document.getElementById('messages');const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const m=MODELS[state.model];msgs.insertAdjacentHTML('beforeend','<div class="message '+type+'"><div class="message-avatar">'+(type==='user'?'YG':'ü§ñ')+'</div><div class="message-content"><div class="message-header"><span class="message-author">'+(type==='user'?'Your Grace':'ABBI')+'</span>'+(type==='ai'?'<div class="message-model"><div class="model-indicator" style="background:'+m.color+'"></div><span>'+m.name+'</span></div>':'')+'<span class="message-time">'+time+'</span></div><div class="message-text">'+text.replace(/\n/g,'<br>')+'</div>'+(type==='ai'?'<div class="message-actions"><button class="action-btn" onclick="copyMsg(this)">üìã Copy</button><button class="action-btn compare-badge">‚ö° Compare</button></div>':'')+'</div></div>');msgs.scrollTop=msgs.scrollHeight;state.history.push({role:type==='user'?'user':'assistant',content:text})}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}}
async function sendMessage(){
    const input=document.getElementById('inputField');
    const text=input.value.trim();
    if(!text)return;
    addMessage('user',text);
    input.value='';
    input.style.height='auto';
    document.getElementById('sendBtn').disabled=true;
    const msgs=document.getElementById('messages');
    const typingId='t-'+Date.now();
    msgs.insertAdjacentHTML('beforeend','<div class="message ai" id="'+typingId+'"><div class="message-avatar">ü§ñ</div><div class="typing-indicator"><div class="typing-dots"><div class="typing-dot" style="background:'+MODELS[state.model].color+'"></div><div class="typing-dot" style="background:'+MODELS[state.model].color+'"></div><div class="typing-dot" style="background:'+MODELS[state.model].color+'"></div></div></div></div>');
    msgs.scrollTop=msgs.scrollHeight;
    try{
        const r=await fetch('/api/chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                model:MODEL_API_IDS[state.model]||'claude-opus-4-5-20251101',
                max_tokens:4096,
                messages:state.history.slice(-10)
            })
        });
        const d=await r.json();
        console.log('API Response:', JSON.stringify(d, null, 2));
        document.getElementById(typingId)?.remove();
        
        // Handle different response structures
        let responseText = '';
        if (d.content && Array.isArray(d.content) && d.content[0]?.text) {
            responseText = d.content[0].text;
        } else if (d.error) {
            responseText = 'API Error: ' + (d.error.message || JSON.stringify(d.error));
        } else if (d.type === 'error') {
            responseText = 'Error: ' + (d.message || JSON.stringify(d));
        } else {
            responseText = 'Response: ' + JSON.stringify(d).substring(0, 500);
        }
        addMessage('ai', responseText);
        await saveConversation();
    }catch(e){
        console.error('Fetch error:', e);
        document.getElementById(typingId)?.remove();
        addMessage('ai','Network Error: '+e.message);
    }
    document.getElementById('sendBtn').disabled=false;
}
function newChat(){state.history=[];state.sessionId='ABBI-'+Math.random().toString(36).substr(2,8).toUpperCase();document.getElementById('sessionId').textContent=state.sessionId;document.getElementById('messages').innerHTML='<div class="context-panel"><div class="context-header"><span class="context-icon">üß†</span><span class="context-title">Hive Mind Active</span></div><div class="context-items"><div class="context-item">MCP Gateway: <span id="toolCount">200+</span> tools</div><div class="context-item">Session: <span id="sessionId">'+state.sessionId+'</span></div></div></div>';addWelcome()}
function copyMsg(b){navigator.clipboard.writeText(b.closest('.message-content').querySelector('.message-text').innerText);b.innerHTML='‚úì Copied';setTimeout(()=>b.innerHTML='üìã Copy',2000)}

// Conversation History Functions
async function loadConversationList(){try{const response=await fetch('/api/conversations/list');const data=await response.json();if(data.conversations&&data.conversations.length>0){displayConversationList(data.conversations)}}catch(error){console.error('Failed to load conversations:',error)}}
function displayConversationList(conversations){const chatList=document.querySelector('.chat-list');if(!chatList)return;chatList.innerHTML='';conversations.forEach(conv=>{const chatItem=document.createElement('div');chatItem.className='chat-item';chatItem.onclick=()=>loadConversation(conv.CONVERSATION_ID);chatItem.innerHTML=`<div class="chat-icon" style="background:var(--accent-primary)"></div><span class="chat-title">${conv.CONVERSATION_TITLE||'Untitled Chat'}</span>`;chatList.appendChild(chatItem)})}
async function loadConversation(conversationId){try{const response=await fetch(`/api/conversations/${conversationId}`);const data=await response.json();if(data.messages){document.getElementById('messages').innerHTML='';state.history=[];state.sessionId=conversationId;document.getElementById('sessionId').textContent=conversationId;data.messages.forEach(msg=>{addMessage(msg.role==='user'?'user':'ai',msg.content,false);state.history.push({role:msg.role,content:msg.content})});document.querySelectorAll('.chat-item').forEach(item=>item.classList.remove('active'));document.querySelector(`[onclick*="${conversationId}"]`)?.classList.add('active');toggleSidebar()}}catch(error){console.error('Failed to load conversation:',error);addMessage('ai','Error: Could not load conversation')}}
async function saveConversation(){if(state.history.length===0)return;try{const firstUserMsg=state.history.find(m=>m.role==='user');const title=firstUserMsg?firstUserMsg.content.substring(0,50)+(firstUserMsg.content.length>50?'...':''):'New Chat';await fetch('/api/conversations/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversationId:state.sessionId,messages:state.history,title:title})});loadConversationList()}catch(error){console.error('Failed to save conversation:',error)}}
function formatTime(timestamp){const date=new Date(timestamp);const now=new Date();const diffDays=Math.floor((now-date)/(1000*60*60*24));if(diffDays===0)return'Today';if(diffDays===1)return'Yesterday';if(diffDays<7)return`${diffDays} days ago`;return date.toLocaleDateString()}
window.addEventListener('DOMContentLoaded',()=>{loadConversationList();loadFolders()});

// Folder Management Functions
async function createFolder(){const folderName=prompt('Enter folder name:');if(!folderName||folderName.trim()==='')return;try{const response=await fetch('/api/folders/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:folderName.trim(),icon:'üìÅ'})});if(response.ok){loadFolders()}}catch(error){console.error('Failed to create folder:',error);alert('Error creating folder')}}
async function loadFolders(){try{const response=await fetch('/api/folders/list');const data=await response.json();if(data.folders){displayFolders(data.folders)}}catch(error){console.error('Failed to load folders:',error)}}
function displayFolders(folders){const folderList=document.getElementById('folderList');if(!folderList)return;folderList.innerHTML='';folders.forEach(folder=>{const folderItem=document.createElement('div');folderItem.className='space-item';folderItem.onclick=()=>{toggleSidebar()};folderItem.innerHTML=`<span class="space-icon">${folder.ICON||'üìÅ'}</span><span class="space-name">${folder.NAME}</span>`;folderList.appendChild(folderItem)})}

// Upload Menu Functions
function toggleUploadMenu(){const menu=document.getElementById('uploadMenu');menu.classList.toggle('open')}
function handleUploadFile(){document.getElementById('fileInput').click();toggleUploadMenu()}
function handleTakePicture(){alert('Camera functionality coming soon');toggleUploadMenu()}
function handleTakeScreenshot(){alert('Screenshot functionality coming soon');toggleUploadMenu()}
function handleFileSelect(event){const file=event.target.files[0];if(file){console.log('File selected:',file.name);alert('File upload: '+file.name+' (Processing coming soon)')}}
document.addEventListener('click',function(e){const menu=document.getElementById('uploadMenu');const btn=document.getElementById('uploadBtn');if(menu&&!menu.contains(e.target)&&e.target!==btn){menu.classList.remove('open')}})

// MCP Gateway Functions
let mcpStatus={servers:[],totalTools:0};
async function loadMCPStatus(){try{const response=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'user',content:'mcp status'}],model:'claude-opus-4-5-20251101',max_tokens:100})});if(response.ok){const reader=response.body.getReader();const decoder=new TextDecoder();let buffer='';while(true){const{done,value}=await reader.read();if(done)break;buffer+=decoder.decode(value,{stream:true});const lines=buffer.split('\n');buffer=lines.pop();for(const line of lines){if(line.startsWith('data: ')){const data=JSON.parse(line.substring(6));if(data.type==='content_block_delta'&&data.delta?.text){const text=data.delta.text;const toolMatch=text.match(/(\d+)\+?\s+tools/i);if(toolMatch){mcpStatus.totalTools=parseInt(toolMatch[1]);document.getElementById('toolCount').textContent=mcpStatus.totalTools+' tools'}}}}}}}catch(error){console.error('Failed to load MCP status:',error);document.getElementById('toolCount').textContent='200+ tools'}}
function showMCPDetails(){document.getElementById('mcpModal').classList.add('open');displayMCPServers()}
function closeMCPModal(){document.getElementById('mcpModal').classList.remove('open')}
function displayMCPServers(){const serverList=document.getElementById('mcpServerList');serverList.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">Loading MCP servers...</div>';fetch('https://mcp-gateway.abbi-ai.com/status').then(r=>r.json()).then(data=>{serverList.innerHTML='';if(data.backends){Object.entries(data.backends).forEach(([name,info])=>{const serverDiv=document.createElement('div');serverDiv.style.cssText='padding:12px;margin:8px 0;background:var(--primary-700);border-radius:8px;cursor:pointer';serverDiv.innerHTML=`<div style="font-weight:600;margin-bottom:4px">${name}</div><div style="font-size:12px;color:var(--text-muted)">Status: ${info.status||'unknown'}</div>`;serverDiv.onclick=()=>showServerTools(name);serverList.appendChild(serverDiv)})}}).catch(()=>{serverList.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">Unable to load MCP servers</div>'})}
function showServerTools(serverName){alert(`Tools for ${serverName} - detailed view coming soon`)}
</script>
</body>
</html>
