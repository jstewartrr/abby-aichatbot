<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABBI - Adaptive Second Brain Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-900: #0A0F1C;
            --primary-800: #151B2E;
            --primary-700: #1E2642;
            --primary-600: #283352;
            --accent-primary: #4F8CFF;
            --accent-secondary: #A855F7;
            --accent-success: #22C55E;
            --accent-warning: #F59E0B;
            --claude-color: #D97706;
            --gpt-color: #10B981;
            --gemini-color: #6366F1;
            --grok-color: #EF4444;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border-subtle: rgba(148, 163, 184, 0.1);
            --border-accent: rgba(79, 140, 255, 0.3);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Inter',sans-serif;background:var(--primary-900);color:var(--text-primary)}
        .app-container{display:flex;flex-direction:column;height:100vh}
        .header{background:var(--primary-800);border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:60px;flex-shrink:0}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
        .logo-text{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:20px;background:linear-gradient(135deg,var(--text-primary),var(--text-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .header-actions{display:flex;align-items:center;gap:16px}
        .model-selector{display:flex;align-items:center;gap:10px;background:var(--primary-700);padding:8px 16px;border-radius:10px;cursor:pointer;border:1px solid var(--border-subtle)}
        .model-indicator{width:10px;height:10px;border-radius:50%;box-shadow:0 0 12px currentColor}
        .model-name{font-weight:600;font-size:14px}
        .status-badge{display:flex;align-items:center;gap:6px;font-size:12px;padding:6px 12px;border-radius:20px}
        .status-badge.online{background:rgba(34,197,94,.1);color:var(--accent-success)}
        .status-badge.offline{background:rgba(239,68,68,.1);color:var(--grok-color)}
        .status-dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
        @keyframes pulse{50%{opacity:.5}}
        .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-primary),var(--gemini-color));display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px}
        .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .chat-messages{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:24px}
        .message{display:flex;gap:16px;max-width:900px;margin:0 auto;width:100%}
        .message-avatar{width:36px;height:36px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px}
        .message.user .message-avatar{background:linear-gradient(135deg,var(--accent-primary),var(--gemini-color))}
        .message.ai .message-avatar{background:var(--primary-700);border:1px solid var(--border-subtle)}
        .message-content{flex:1;display:flex;flex-direction:column;gap:8px;min-width:0}
        .message-header{display:flex;align-items:center;gap:8px}
        .message-author{font-weight:600;font-size:14px}
        .message-model{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)}
        .message-model .model-indicator{width:6px;height:6px}
        .message-time{font-size:12px;color:var(--text-muted);margin-left:auto}
        .message-text{font-size:15px;line-height:1.7;color:var(--text-secondary);word-wrap:break-word}
        .message.ai .message-text{background:var(--primary-800);padding:16px 20px;border-radius:12px;border:1px solid var(--border-subtle)}
        .message-actions{display:flex;align-items:center;gap:8px;margin-top:8px}
        .action-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;background:transparent;border:1px solid var(--border-subtle);border-radius:6px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all .2s}
        .action-btn:hover{background:var(--primary-700);color:var(--text-secondary)}
        .context-panel{background:linear-gradient(135deg,rgba(79,140,255,.1),rgba(168,85,247,.1));border:1px solid var(--border-accent);border-radius:12px;padding:16px;max-width:900px;margin:0 auto;width:100%}
        .context-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .context-icon{font-size:18px}
        .context-title{font-size:14px;font-weight:600;color:var(--accent-primary)}
        .context-items{display:flex;flex-direction:column;gap:8px}
        .context-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
        .input-area{padding:20px 24px;border-top:1px solid var(--border-subtle);background:var(--primary-800);flex-shrink:0}
        .input-container{max-width:900px;margin:0 auto}
        .input-wrapper{display:flex;align-items:flex-end;gap:12px;background:var(--primary-900);border:1px solid var(--border-subtle);border-radius:16px;padding:12px 16px;transition:border-color .2s}
        .input-wrapper:focus-within{border-color:var(--accent-primary)}
        .input-field{flex:1;background:transparent;border:none;color:var(--text-primary);font-size:15px;font-family:'Inter',sans-serif;resize:none;min-height:24px;max-height:120px;outline:none}
        .input-field::placeholder{color:var(--text-muted)}
        .input-actions{display:flex;align-items:center;gap:8px}
        .send-btn{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s;font-size:16px}
        .send-btn:hover{transform:scale(1.05)}
        .send-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .typing-indicator{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--primary-800);border-radius:12px;width:fit-content}
        .typing-dots{display:flex;gap:4px}
        .typing-dot{width:8px;height:8px;border-radius:50%;background:var(--claude-color);animation:typing 1.4s infinite}
        .typing-dot:nth-child(2){animation-delay:.2s}
        .typing-dot:nth-child(3){animation-delay:.4s}
        @keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-6px);opacity:1}}
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--primary-600);border-radius:4px}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">AI</div>
                <span class="logo-text">ABBI Chatbot</span>
            </div>
            <div class="header-actions">
                <div class="model-selector" id="modelSelector">
                    <div class="model-indicator" id="modelDot" style="background:var(--claude-color)"></div>
                    <span class="model-name" id="modelLabel">Claude Sonnet 4</span>
                </div>
                <div class="status-badge online" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Connected</span>
                </div>
                <div class="user-avatar">YG</div>
            </div>
        </header>
        
        <main class="chat-area">
            <div class="chat-messages" id="messages">
                <div class="context-panel">
                    <div class="context-header">
                        <span class="context-icon">ðŸ§ </span>
                        <span class="context-title">Hive Mind Context Active</span>
                    </div>
                    <div class="context-items">
                        <div class="context-item">MCP Gateway: <span id="toolCount">Loading...</span> tools</div>
                        <div class="context-item">Session: <span id="sessionId">--</span></div>
                        <div class="context-item">Model: <span id="contextModel">Claude Sonnet 4</span></div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea class="input-field" id="inputField" placeholder="Message ABBI..." rows="1" onkeydown="handleKey(event)"></textarea>
                        <div class="input-actions">
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">âž¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
const CONFIG = {
    gateway: '/api/gateway',
    claudeAPI: '/api/chat'
};

const MODELS = {
    claude: { name: 'Claude Sonnet 4', color: 'var(--claude-color)' }
};

let state = {
    model: 'claude',
    sessionId: null,
    messages: [],
    conversationHistory: [],
    gateway: null
};

document.addEventListener('DOMContentLoaded', () => {
    state.sessionId = 'ABBI-' + Math.random().toString(36).substring(2, 10).toUpperCase();
    document.getElementById('sessionId').textContent = state.sessionId;
    
    document.getElementById('inputField').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    init();
});

async function init() {
    await refreshGateway();
    addWelcomeMessage();
}

async function refreshGateway() {
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    
    try {
        const r = await fetch(CONFIG.gateway);
        const d = await r.json();
        state.gateway = d;
        
        statusBadge.className = 'status-badge online';
        statusText.textContent = d.total_tools + ' tools';
        document.getElementById('toolCount').textContent = d.total_tools;
    } catch (e) {
        statusBadge.className = 'status-badge offline';
        statusText.textContent = 'Offline';
        document.getElementById('toolCount').textContent = '200+';
    }
}

function addWelcomeMessage() {
    const toolCount = state.gateway?.total_tools || '200+';
    addMessage('ai', `Welcome back, Your Grace. I'm ABBI, your Adaptive Second Brain Intelligence.

I have access to ${toolCount} tools via the MCP Gateway, including Asana, Google Drive, Make.com, Snowflake, Microsoft 365, and many more.

How may I assist you today?`, []);
}

function addMessage(type, text, toolCalls = []) {
    const messages = document.getElementById('messages');
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const model = MODELS[state.model];
    
    const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    
    const msgHtml = `
        <div class="message ${type}">
            <div class="message-avatar">${type === 'user' ? 'YG' : 'ðŸ¤–'}</div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-author">${type === 'user' ? 'Your Grace' : 'ABBI'}</span>
                    ${type === 'ai' ? `
                        <div class="message-model">
                            <div class="model-indicator" style="background:${model.color}"></div>
                            <span>${model.name}</span>
                        </div>
                    ` : ''}
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-text">${formattedText}</div>
                ${type === 'ai' ? `
                    <div class="message-actions">
                        <button class="action-btn" onclick="copyMessage(this)">ðŸ“‹ Copy</button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    messages.insertAdjacentHTML('beforeend', msgHtml);
    messages.scrollTop = messages.scrollHeight;
    
    if (type === 'user') {
        state.conversationHistory.push({ role: 'user', content: text });
    } else {
        state.conversationHistory.push({ role: 'assistant', content: text });
    }
}

function addTypingIndicator() {
    const messages = document.getElementById('messages');
    const id = 'typing-' + Date.now();
    const model = MODELS[state.model];
    
    messages.insertAdjacentHTML('beforeend', `
        <div class="message ai" id="${id}">
            <div class="message-avatar">ðŸ¤–</div>
            <div class="typing-indicator">
                <div class="typing-dots">
                    <div class="typing-dot" style="background:${model.color}"></div>
                    <div class="typing-dot" style="background:${model.color}"></div>
                    <div class="typing-dot" style="background:${model.color}"></div>
                </div>
                <span style="font-size:13px;color:var(--text-muted)">${model.name} is thinking...</span>
            </div>
        </div>
    `);
    messages.scrollTop = messages.scrollHeight;
    return id;
}

function removeTypingIndicator(id) {
    document.getElementById(id)?.remove();
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('inputField');
    const sendBtn = document.getElementById('sendBtn');
    const text = input.value.trim();
    
    if (!text) return;
    
    addMessage('user', text);
    input.value = '';
    input.style.height = 'auto';
    sendBtn.disabled = true;
    
    const typingId = addTypingIndicator();
    
    try {
        const result = await callClaudeAPI(text);
        removeTypingIndicator(typingId);
        addMessage('ai', result.text, result.toolCalls || []);
    } catch (e) {
        removeTypingIndicator(typingId);
        addMessage('ai', `I encountered an issue: ${e.message}\n\nPlease try again.`, []);
    }
    
    sendBtn.disabled = false;
}

async function callClaudeAPI(message) {
    const systemPrompt = `You are ABBI (Adaptive Second Brain Intelligence), a sophisticated AI assistant for Your Grace.

You have access to the MCP Gateway with ${state.gateway?.total_tools || 200}+ tools including:
- Asana: Task management
- Google Drive: Document access
- Make.com: Workflow automation
- Snowflake: Data queries
- Microsoft 365: Email and calendar

Current session: ${state.sessionId}
Be helpful, concise, and address the user as "Your Grace" when appropriate.`;

    const messages = state.conversationHistory.slice(-10);
    
    const response = await fetch(CONFIG.claudeAPI, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 4096,
            system: systemPrompt,
            messages: messages
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || `API error: ${response.status}`);
    }
    
    const data = await response.json();
    let text = '';
    let toolCalls = [];
    
    if (data.content) {
        for (const block of data.content) {
            if (block.type === 'text') {
                text += block.text;
            } else if (block.type === 'tool_use') {
                toolCalls.push({ name: block.name, input: block.input });
            }
        }
    }
    
    return { text: text || 'I processed your request.', toolCalls };
}

function copyMessage(btn) {
    const text = btn.closest('.message-content').querySelector('.message-text').innerText;
    navigator.clipboard.writeText(text);
    btn.innerHTML = 'âœ“ Copied';
    setTimeout(() => btn.innerHTML = 'ðŸ“‹ Copy', 2000);
}
</script>
</body>
</html>